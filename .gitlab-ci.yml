stages:
  - build
  - test

default:
  tags:
    - shell
    - clonezilla

variables:
  CLONEZILLA_BASE_URL: "https://free.nchc.org.tw/clonezilla-live/stable"
  ZIP_DIR: "zip"
  ZIP_PATTERN: "clonezilla-live-.*\\.zip"
  CURL_OPTS: "-fsSL"

build_latest_zip:
  stage: build
  script:
    - mkdir -p "${ZIP_DIR}"

    - |
      echo "get zip name..."
      LATEST_ZIP=$(curl ${CURL_OPTS} "${CLONEZILLA_BASE_URL}/" \
        | grep -Eo 'href="clonezilla-live-[^"]+\.zip"' \
        | cut -d'"' -f2 \
        | sort -V \
        | tail -n1)

      if [ -z "${LATEST_ZIP}" ]; then
        echo "can't fine ${ZIP_PATTERN} !" >&2
        exit 1
      fi
      echo "zip name: ${LATEST_ZIP}"
      export LATEST_ZIP

    - |
      DOWNLOAD_URL="${CLONEZILLA_BASE_URL}/${LATEST_ZIP}"
      DEST_FILE="${ZIP_DIR}/${LATEST_ZIP}"
      echo "downloading ${DOWNLOAD_URL} to ${DEST_FILE}"
      curl ${CURL_OPTS} -o "${DEST_FILE}" "${DOWNLOAD_URL}"
      echo "finish"

  artifacts:
    name: "clonezilla-live-zip"
    paths:
      - "${ZIP_DIR}/"
    expire_in: 7 day

  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - "${ZIP_DIR}/"

.test_template:
  stage: test
  variables:
    LIBGUESTFS_DEBUG: "0"
    LIBGUESTFS_TRACE: "0"
  dependencies:
    - build_latest_zip
  before_script:
    - |
      echo "Setting up qemu cloud images in the project root..."
      if [ -d "/data/cloudimages" ]; then
        mkdir -p qemu/cloudimages
        ln -s /data/cloudimages/*.qcow2 qemu/cloudimages/
        echo "Linked cloud images from /data/cloudimages."
      else
        echo "Warning: /data/cloudimages not found. OS tests will fail if images are not present."
      fi
    - |
      echo "Verifying build artifact (Clonezilla ZIP)..."
      if ! ls ${ZIP_DIR}/*.zip > /dev/null 2>&1; then
        echo "Error: Artifact zip file not found in ${ZIP_DIR}/" >&2
        echo "Listing contents of current directory ('.'):"
        ls -lA
        exit 1
      fi
    - |
      export ZIP_FILE=$(basename $(ls ${ZIP_DIR}/*.zip | head -n1))
      if [ -z "${ZIP_FILE}" ]; then
        echo "Error: Failed to find zip file in ${ZIP_DIR}/." >&2
        echo "Listing contents of ${ZIP_DIR}/ :"
        ls -l ${ZIP_DIR}/
        exit 1
      fi
      echo "Using ZIP file: ${ZIP_FILE}"
    - |
      echo "Preparing log directory..."
      export LOG_DIR="./logs"
      mkdir -p $LOG_DIR
  artifacts:
    when: always
    paths:
      - clonezilla-ci/log/*.log
    expire_in: 5 days
  timeout: 4h

# --- OS Tests ---

test:os:ubuntu:
  extends: .test_template
  parallel:
    matrix:
      - ARCH: [amd64]
  script:
    - |
      os="ubuntu"
      echo "--- Running OS Clone/Restore Tests for Ubuntu ($ARCH) ---"
      grep -E "^\s*${os}\s+.*\s+${ARCH}\s+" qemu/cloudimages/cloud_images.conf | while IFS= read -r config_line; do
          release=$(echo "$config_line" | awk '{print $2}')
          image_name="${os}-${release}-${ARCH}.qcow2"
          image_path="qemu/cloudimages/${image_name}"

          if [ -f "$image_path" ]; then
              echo "--- Testing ${image_path} ---"
              log_file="$LOG_DIR/os_ubuntu_${release}_${ARCH}_$(date +%Y%m%d_%H%M%S).log"
              ./os-clone-restore.sh --zip "${ZIP_DIR}/${ZIP_FILE}" --tmpl "$image_path" --arch "$ARCH" --validate-iso "isos/cidata.iso" 2>&1 | tee -a "$log_file"
              rc=${PIPESTATUS[0]}
              if [ $rc -ne 0 ]; then
                  echo "--- Test FAILED for ${image_path} ---"
                  exit 1
              fi
              echo "--- Test PASSED for ${image_path} ---"
          else
              echo "Skipping test for ${os}-${release}-${ARCH}: image file not found at ${image_path}"
          fi
      done

test:os:debian:
  extends: .test_template
  parallel:
    matrix:
      - ARCH: [amd64]
  script:
    - |
      os="debian"
      echo "--- Running OS Clone/Restore Tests for Debian ($ARCH) ---"
      grep -E "^\s*${os}\s+.*\s+${ARCH}\s+" qemu/cloudimages/cloud_images.conf | while IFS= read -r config_line; do
          release=$(echo "$config_line" | awk '{print $2}')
          image_name="${os}-${release}-${ARCH}.qcow2"
          image_path="qemu/cloudimages/${image_name}"

          if [ -f "$image_path" ]; then
              echo "--- Testing ${image_path} ---"
              log_file="$LOG_DIR/os_debian_${release}_${ARCH}_$(date +%Y%m%d_%H%M%S).log"
              ./os-clone-restore.sh --zip "${ZIP_DIR}/${ZIP_FILE}" --tmpl "$image_path" --arch "$ARCH" --validate-iso "isos/cidata.iso" 2>&1 | tee -a "$log_file"
              rc=${PIPESTATUS[0]}
              if [ $rc -ne 0 ]; then
                  echo "--- Test FAILED for ${image_path} ---"
                  exit 1
              fi
              echo "--- Test PASSED for ${image_path} ---"
          else
              echo "Skipping test for ${os}-${release}-${ARCH}: image file not found at ${image_path}"
          fi
      done

test:os:fedora:
  extends: .test_template
  parallel:
    matrix:
      - ARCH: [amd64]
  script:
    - |
      os="fedora"
      echo "--- Running OS Clone/Restore Tests for Fedora ($ARCH) ---"
      grep -E "^\s*${os}\s+.*\s+${ARCH}\s+" qemu/cloudimages/cloud_images.conf | while IFS= read -r config_line; do
          release=$(echo "$config_line" | awk '{print $2}')
          image_name="${os}-${release}-${ARCH}.qcow2"
          image_path="qemu/cloudimages/${image_name}"

          if [ -f "$image_path" ]; then
              echo "--- Testing ${image_path} ---"
              log_file="$LOG_DIR/os_fedora_${release}_${ARCH}_$(date +%Y%m%d_%H%M%S).log"
              ./os-clone-restore.sh --zip "${ZIP_DIR}/${ZIP_FILE}" --tmpl "$image_path" --arch "$ARCH" --validate-iso "isos/cidata.iso" 2>&1 | tee -a "$log_file"
              rc=${PIPESTATUS[0]}
              if [ $rc -ne 0 ]; then
                  echo "--- Test FAILED for ${image_path} ---"
                  exit 1
              fi
              echo "--- Test PASSED for ${image_path} ---"
          else
              echo "Skipping test for ${os}-${release}-${ARCH}: image file not found at ${image_path}"
          fi
      done

test:os:windows11:
  extends: .test_template
  parallel:
    matrix:
      - ARCH: [amd64]
  script:
    - |
      image_path="qemu/cloudimages/windows-11-${ARCH}.qcow2"
      echo "--- Running OS Clone/Restore Test for Windows 11 ($ARCH) ---"
      if [ -f "$image_path" ]; then
          echo "--- Testing ${image_path} ---"
          log_file="$LOG_DIR/os_windows11_${ARCH}_$(date +%Y%m%d_%H%M%S).log"
          ./os-clone-restore.sh --zip "${ZIP_DIR}/${ZIP_FILE}" --tmpl "$image_path" --arch "$ARCH" --validate-iso "isos/win11_cidata.iso" 2>&1 | tee -a "$log_file"
          rc=${PIPESTATUS[0]}
          if [ $rc -ne 0 ]; then
              echo "--- Test FAILED for ${image_path} ---"
              exit 1
          fi
          echo "--- Test PASSED for ${image_path} ---"
      else
          echo "Skipping test for Windows 11: image file not found at ${image_path}"
      fi

# --- Filesystem Tests ---

.fs_test_template:
  extends: .test_template
  parallel:
    matrix:
      - ARCH: [amd64]
  script:
    - |
      echo "--- Running FS Clone/Restore Test with $FS ($ARCH) ---"
      log_file="$LOG_DIR/fs_${FS}_${ARCH}_$(date +%Y%m%d_%H%M%S).log"
      ./data-clone-restore.sh --zip "${ZIP_DIR}/${ZIP_FILE}" --data dev/testData --fs "$FS" --arch "$ARCH" 2>&1 | tee -a "$log_file"
      rc=${PIPESTATUS[0]}
      if [ $rc -ne 0 ]; then
          echo "--- Test FAILED for filesystem $FS ---"
          exit 1
      fi
      echo "--- Test PASSED for filesystem $FS ---"

test:fs:exfat:
  extends: .fs_test_template
  variables:
    FS: exfat

test:fs:ntfs:
  extends: .fs_test_template
  variables:
    FS: ntfs

test:fs:vfat:
  extends: .fs_test_template
  variables:
    FS: vfat

test:fs:ext4:
  extends: .fs_test_template
  variables:
    FS: ext4

test:fs:xfs:
  extends: .fs_test_template
  variables:
    FS: xfs

test:fs:btrfs:
  extends: .fs_test_template
  variables:
    FS: btrfs
